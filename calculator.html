<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>分割計算</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
    font-family: "Meiryo", "ＭＳ Ｐゴシック", sans-serif;
    padding: 4px;
    background: #f8f8f8;
}
h3 {
    margin-top: 2px;
    margin-bottom: 2px;
    font-size: 1.2em;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
h3 span {
    font-size: 0.8em;
    margin-left: 10px;
    color: #007bff;
}
table { border-collapse: collapse; font-size: 1em; width: 100%; }
th, td {
    border: 1px solid #888;
    padding: 4px;
}
th { background: #cceeff; }
td.label, .high-label { text-align: left; }
td.value { text-align: right; min-width: 70px; }
td input[type="checkbox"] {
    margin: auto;
    display: block;
}
td.discount-value {
    color: red !important;
}
button, select, input[type="number"] {
    font-size: 1.1em;
    padding: 12px;
    margin: 0 4px 6px 0;
    border-radius: 5px;
    border: 1px solid #aaa;
    box-sizing: border-box;
}
input[type="checkbox"] { width: 20px; height: 20px; }
label {
    display: block;
    margin-bottom: 4px;
    font-size: 1em;
}
input[type="number"] {
    width: 100px;
    text-align: right;
}
#controls {
    width: 100%;
    margin-bottom: 6px;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 6px #ddd;
    padding: 8px;
    box-sizing: border-box;
}
#result {
    margin-top: 8px;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 6px #eee;
}
.product-box {
    width: 100%;
    margin: 0 0 8px 0;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 6px #eee;
    padding: 4px;
    box-sizing: border-box;
}
#textTable { width: 100%; }

@media (min-width: 900px) {
    #textTable { display: flex; flex-wrap: wrap; justify-content: space-between; }
    .product-box { width: 32%; margin: 0 0 12px 0; }
}
.high-label { width: 38vw; min-width: 80px; }
.high-checkbox { text-align: center; width: 11vw; }
.responsive-table { display: block; overflow-x: auto; width: 100%; }
.collapsed {
    display: none;
}
.hidden {
    display: none;
}
</style>
</head>
<body>

<div id="controls">
<h3>分割計算</h3>
<label>信販会社：
<select id="credit">
    <option value="0.006">DL（0.6%）</option>
    <option value="0.0065">タイヘイ（0.65%）</option>
    <option value="0.0058">ニチクレ（0.58%）</option>
    <option value="0.006">九日（0.6%）</option>
    <option value="0.006">マスター（0.6%）</option>
</select>
</label>
<label>分割回数：
<input type="tel" id="install" value="" min="1" max="36">
</label>

<label style="display: flex; align-items: center; margin-bottom: 8px;">
    <input type="checkbox" id="irregularCheck" onchange="toggleIrregularInput()" style="margin-right: 8px;">
    イレギュラー計算
</label>

<div id="irregularBonusContainer" class="hidden">
    <label>ボーナス月加算分割支払金（任意）：
        <input type="number" id="bonusPerInput" value="" min="0" placeholder="1回あたりの金額を入力">
    </label>
</div>

<button onclick="calculate()">計算</button>
<button onclick="resetChecks()">リセット</button>
<div id="result"></div>
</div>

<div id="textTable">
    <div class="product-box">
        <h3 onclick="toggleTable('table1')">小学生パワーアップゼミ <span id="toggle_icon_table1">[+]</span></h3>
        <div id="table1" class="responsive-table collapsed">
        <table>
            <tr><th></th><th>小1</th><th>小2</th><th>小3</th><th>小4</th><th>小5</th><th>小6</th></tr>
            <tr><td>英語</td><td><input type="checkbox" id="eng1"></td><td><input type="checkbox" id="eng2"></td><td><input type="checkbox" id="eng3"></td><td><input type="checkbox" id="eng4"></td><td><input type="checkbox" id="eng5"></td><td><input type="checkbox" id="eng6"></td></tr>
            <tr><td>算数</td><td><input type="checkbox" id="math1"></td><td><input type="checkbox" id="math2"></td><td><input type="checkbox" id="math3"></td><td><input type="checkbox" id="math4"></td><td><input type="checkbox" id="math5"></td><td><input type="checkbox" id="math6"></td></tr>
            <tr><td>国語</td><td><input type="checkbox" id="jp1"></td><td><input type="checkbox" id="jp2"></td><td><input type="checkbox" id="jp3"></td><td><input type="checkbox" id="jp4"></td><td><input type="checkbox" id="jp5"></td><td><input type="checkbox" id="jp6"></td></tr>
            <tr><td>理科</td><td>-</td><td>-</td><td>-</td><td>-</td><td><input type="checkbox" id="sci5"></td><td><input type="checkbox" id="sci6"></td></tr>
            <tr><td>社会</td><td>-</td><td>-</td><td>-</td><td>-</td><td><input type="checkbox" id="soc5"></td><td><input type="checkbox" id="soc6"></td></tr>
        </table>
        </div>
    </div>

    <div class="product-box">
        <h3 onclick="toggleTable('table2')">サマー練成・ウィンター練成 <span id="toggle_icon_table2">[+]</span></h3>
        <div id="table2" class="responsive-table collapsed">
        <table>
            <tr><th></th><th>小1</th><th>小2</th><th>小3</th><th>小4</th><th>小5</th><th>小6</th></tr>
            <tr><td>英語</td><td><input type="checkbox" id="summer_eng1"></td><td><input type="checkbox" id="summer_eng2"></td><td><input type="checkbox" id="summer_eng3"></td><td><input type="checkbox" id="summer_eng4"></td><td><input type="checkbox" id="summer_eng5"></td><td><input type="checkbox" id="summer_eng6"></td></tr>
            <tr><td>算数</td><td><input type="checkbox" id="summer_math1"></td><td><input type="checkbox" id="summer_math2"></td><td><input type="checkbox" id="summer_math3"></td><td><input type="checkbox" id="summer_math4"></td><td><input type="checkbox" id="summer_math5"></td><td><input type="checkbox" id="summer_math6"></td></tr>
            <tr><td>国語</td><td><input type="checkbox" id="summer_jp1"></td><td><input type="checkbox" id="summer_jp2"></td><td><input type="checkbox" id="summer_jp3"></td><td><input type="checkbox" id="summer_jp4"></td><td><input type="checkbox" id="summer_jp5"></td><td><input type="checkbox" id="summer_jp6"></td></tr>
            <tr><td>理科</td><td>-</td><td>-</td><td>-</td><td><input type="checkbox" id="summer_sci4"></td><td><input type="checkbox" id="summer_sci5"></td><td><input type="checkbox" id="summer_sci6"></td></tr>
            <tr><td>社会</td><td>-</td><td>-</td><td>-</td><td><input type="checkbox" id="summer_soc4"></td><td><input type="checkbox" id="summer_soc5"></td><td><input type="checkbox" id="summer_soc6"></td></tr>
        </table>
        </div>
    </div>

    <div class="product-box">
        <h3 onclick="toggleTable('table3')">マイジュック <span id="toggle_icon_table3">[+]</span></h3>
        <div id="table3" class="responsive-table collapsed">
        <table>
            <tr><th></th><th>小1</th><th>小2</th><th>小3</th><th>小4</th><th>小5</th><th>小6</th></tr>
            <tr><td>英語</td><td><input type="checkbox" id="my_eng1"></td><td><input type="checkbox" id="my_eng2"></td><td><input type="checkbox" id="my_eng3"></td><td><input type="checkbox" id="my_eng4"></td><td><input type="checkbox" id="my_eng5"></td><td><input type="checkbox" id="my_eng6"></td></tr>
            <tr><td>算数</td><td><input type="checkbox" id="my_math1"></td><td><input type="checkbox" id="my_math2"></td><td><input type="checkbox" id="my_math3"></td><td><input type="checkbox" id="my_math4"></td><td><input type="checkbox" id="my_math5"></td><td><input type="checkbox" id="my_math6"></td></tr>
            <tr><td>国語</td><td><input type="checkbox" id="my_jp1"></td><td><input type="checkbox" id="my_jp2"></td><td><input type="checkbox" id="my_jp3"></td><td><input type="checkbox" id="my_jp4"></td><td><input type="checkbox" id="my_jp5"></td><td><input type="checkbox" id="my_jp6"></td></tr>
            <tr><td>理科</td><td>-</td><td>-</td><td>-</td><td><input type="checkbox" id="my_sci4"></td><td><input type="checkbox" id="my_sci5"></td><td><input type="checkbox" id="my_sci6"></td></tr>
            <tr><td>社会</td><td>-</td><td>-</td><td>-</td><td><input type="checkbox" id="my_soc4"></td><td><input type="checkbox" id="my_soc5"></td><td><input type="checkbox" id="my_soc6"></td></tr>
        </table>
        </div>
    </div>

    <div class="product-box">
        <h3 onclick="toggleTable('table4')">中学生パワーアップゼミ <span id="toggle_icon_table4">[+]</span></h3>
        <div id="table4" class="responsive-table collapsed">
        <table>
            <tr><th></th><th>中1</th><th>中2</th><th>中3</th></tr>
            <tr><td>英語</td><td><input type="checkbox" id="jun_eng1"></td><td><input type="checkbox" id="jun_eng2"></td><td><input type="checkbox" id="jun_eng3"></td></tr>
            <tr><td>数学</td><td><input type="checkbox" id="jun_math1"></td><td><input type="checkbox" id="jun_math2"></td><td><input type="checkbox" id="jun_math3"></td></tr>
            <tr><td>国語</td><td><input type="checkbox" id="jun_jp1"></td><td><input type="checkbox" id="jun_jp2"></td><td><input type="checkbox" id="jun_jp3"></td></tr>
            <tr><td>理科</td><td><input type="checkbox" id="jun_sci1"></td><td><input type="checkbox" id="jun_sci2"></td><td><input type="checkbox" id="jun_sci3"></td></tr>
            <tr><td>社会</td><td><input type="checkbox" id="jun_soc1"></td><td><input type="checkbox" id="jun_soc2"></td><td><input type="checkbox" id="jun_soc3"></td></tr>
        </table>
        </div>
    </div>

    <div class="product-box">
        <h3 onclick="toggleTable('table5')">中学生Focus <span id="toggle_icon_table5">[+]</span></h3>
        <div id="table5" class="responsive-table collapsed">
        <table>
            <tr><th></th><th>中1</th><th>中2</th><th>中3</th></tr>
            <tr><td>英語</td><td><input type="checkbox" id="focus_eng1"></td><td><input type="checkbox" id="focus_eng2"></td><td><input type="checkbox" id="focus_eng3"></td></tr>
            <tr><td>数学</td><td><input type="checkbox" id="focus_math1"></td><td><input type="checkbox" id="focus_math2"></td><td><input type="checkbox" id="focus_math3"></td></tr>
            <tr><td>国語</td><td><input type="checkbox" id="focus_jp1"></td><td><input type="checkbox" id="focus_jp2"></td><td><input type="checkbox" id="focus_jp3"></td></tr>
            <tr><td>理科</td><td><input type="checkbox" id="focus_sci1"></td><td><input type="checkbox" id="focus_sci2"></td><td><input type="checkbox" id="focus_sci3"></td></tr>
            <tr><td>社会</td><td><input type="checkbox" id="focus_soc1"></td><td><input type="checkbox" id="focus_soc2"></td><td><input type="checkbox" id="focus_soc3"></td></tr>
        </table>
        </div>
    </div>

    <div class="product-box">
        <h3 onclick="toggleTable('table6')">中学生パワーアップゼミ（ライト版） <span id="toggle_icon_table6">[+]</span></h3>
        <div id="table6" class="responsive-table collapsed">
        <table>
            <tr><th></th><th>中1</th><th>中2</th><th>中3</th></tr>
            <tr><td>英語</td><td><input type="checkbox" id="light_eng1"></td><td><input type="checkbox" id="light_eng2"></td><td><input type="checkbox" id="light_eng3"></td></tr>
            <tr><td>数学</td><td><input type="checkbox" id="light_math1"></td><td><input type="checkbox" id="light_math2"></td><td><input type="checkbox" id="light_math3"></td></tr>
            <tr><td>国語</td><td><input type="checkbox" id="light_jp1"></td><td><input type="checkbox" id="light_jp2"></td><td><input type="checkbox" id="light_jp3"></td></tr>
            <tr><td>理科</td><td><input type="checkbox" id="light_sci1"></td><td><input type="checkbox" id="light_sci2"></td><td><input type="checkbox" id="light_sci3"></td></tr>
            <tr><td>社会</td><td><input type="checkbox" id="light_soc1"></td><td><input type="checkbox" id="light_soc2"></td><td><input type="checkbox" id="light_soc3"></td></tr>
        </table>
        </div>
    </div>

    <div class="product-box">
        <h3 onclick="toggleTable('table7')">高校SPIRAL・現役合格システム <span id="toggle_icon_table7">[+]</span></h3>
        <div id="table7" class="responsive-table collapsed">
        <table>
            <tr><td class="high-label">英語Ⅰ</td><td class="high-checkbox"><input type="checkbox" id="high_eng1"></td><td class="high-label">英語Ⅱ</td><td class="high-checkbox"><input type="checkbox" id="high_eng2"></td></tr>
            <tr><td class="high-label">数学Ⅰ</td><td class="high-checkbox"><input type="checkbox" id="high_math1"></td><td class="high-label">数学A</td><td class="high-checkbox"><input type="checkbox" id="high_mathA"></td></tr>
            <tr><td class="high-label">数学Ⅱ</td><td class="high-checkbox"><input type="checkbox" id="high_math2"></td><td class="high-label">数学B</td><td class="high-checkbox"><input type="checkbox" id="high_mathB"></td></tr>
            <tr><td class="high-label">数学Ⅲ</td><td class="high-checkbox"><input type="checkbox" id="high_math3"></td><td class="high-label">数学C</td><td class="high-checkbox"><input type="checkbox" id="high_mathC"></td></tr>
            <tr><td class="high-label">現代文</td><td class="high-checkbox"><input type="checkbox" id="high_jpMod"></td><td class="high-label">現代文演習</td><td class="high-checkbox"><input type="checkbox" id="high_jpModEx"></td></tr>
            <tr><td class="high-label">入試現代文演習</td><td class="high-checkbox"><input type="checkbox" id="high_jpModExam"></td><td class="high-label">古文</td><td class="high-checkbox"><input type="checkbox" id="high_jpCla"></td></tr>
            <tr><td class="high-label">古文演習</td><td class="high-checkbox"><input type="checkbox" id="high_jpClaEx"></td><td class="high-label">入試古文演習</td><td class="high-checkbox"><input type="checkbox" id="high_jpClaExam"></td></tr>
            <tr><td class="high-label">漢文</td><td class="high-checkbox"><input type="checkbox" id="high_jpChi"></td><td class="high-label">漢文演習</td><td class="high-checkbox"><input type="checkbox" id="high_jpChiEx"></td></tr>
            <tr><td class="high-label">入試漢文演習</td><td class="high-checkbox"><input type="checkbox" id="high_jpChiExam"></td><td class="high-label">物理基礎</td><td class="high-checkbox"><input type="checkbox" id="high_sciPhy"></td></tr>
            <tr><td class="high-label">生物基礎</td><td class="high-checkbox"><input type="checkbox" id="high_sciBio"></td><td class="high-label">化学基礎</td><td class="high-checkbox"><input type="checkbox" id="high_sciChem"></td></tr>
            <tr><td class="high-label">地理総合</td><td class="high-checkbox"><input type="checkbox" id="high_socGeo"></td><td class="high-label">歴史総合</td><td class="high-checkbox"><input type="checkbox" id="high_socHist"></td></tr>
        </table>
        </div>
    </div>

</div>

<script type="text/javascript">
/* ユーティリティ */
function formatInt(n){
    n = Math.floor(Number(n) || 0);
    var s = n.toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
function isChecked(id){
    var el = document.getElementById(id);
    return el ? el.checked : false;
}

/* 価格定義 (変更なし) */
var PRICE = {
    eng:39600, math:39600, jp:39600, sci:26400, soc:26400,
    summerMap: {2:30000,3:44000,5:66000},
    focusMap: {2:30000,3:44000,5:66000},
    my:39600,
    light_eng:19800, light_math:19800, light_jp:19800, light_sci:13200, light_soc:13200,
    high:52800
};

/* 値引きテーブル (変更なし) */
var discountTable = [
    {min:200000,max:249999,discount24:7000,discount36:10000},
    {min:250000,max:299999,discount24:15000,discount36:20000},
    {min:300000,max:349999,discount24:21000,discount36:30000},
    {min:350000,max:399999,discount24:28000,discount36:40000},
    {min:400000,max:449999,discount24:32000,discount36:43000},
    {min:450000,max:499999,discount24:35000,discount36:46000},
    {min:500000,max:599999,discount24:40000,discount36:55000},
    {min:600000,max:699999,discount24:50000,discount36:72000},
    {min:700000,max:9999999,discount24:60000,discount36:83000}
];

/* 値引き計算関数 (変更なし) */
function getDiscount(total, install){
    if(isNaN(total) || total < 200000) return 0;
    var inst = install;
    if(inst === 1) inst = 24;
    if(inst >= 2 && inst <= 23) return 0;
    for(var i=0;i<discountTable.length;i++){
        if(total >= discountTable[i].min && total <= discountTable[i].max){
            return (inst === 24 ? discountTable[i].discount24 : discountTable[i].discount36);
        }
    }
    return 0;
}

/**
 * イレギュラー計算の入力欄の表示/非表示を切り替える
 */
function toggleIrregularInput() {
    var check = document.getElementById('irregularCheck').checked;
    var container = document.getElementById('irregularBonusContainer');
    if (check) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
        document.getElementById('bonusPerInput').value = ""; // 入力値をクリア
    }
}


/**
 * ポイント合計を計算する (マイジュック理社は1.0Pで修正済み)
 */
function calculatePoints(){
    var totalPoints = 0;

    // 小学生パワーアップゼミ (英算国: 1P, 理社: 0.5P)
    for(var g=1; g<=6; g++){
        if(isChecked("eng"+g)) totalPoints += 1;
        if(isChecked("math"+g)) totalPoints += 1;
        if(isChecked("jp"+g)) totalPoints += 1;
        if(g>=5){
            if(isChecked("sci"+g)) totalPoints += 0.5;
            if(isChecked("soc"+g)) totalPoints += 0.5;
        }
    }
    
    // 中学生パワーアップゼミ (英数国: 1P, 理社: 0.5P)
    for(var g=1; g<=3; g++){
        if(isChecked("jun_eng"+g)) totalPoints += 1;
        if(isChecked("jun_math"+g)) totalPoints += 1;
        if(isChecked("jun_jp"+g)) totalPoints += 1;
        if(isChecked("jun_sci"+g)) totalPoints += 0.5;
        if(isChecked("jun_soc"+g)) totalPoints += 0.5;
    }

    // マイジュック (全科目 1.0P)
    for(var g=1; g<=6; g++){
        if(isChecked("my_eng"+g)) totalPoints += 1;
        if(isChecked("my_math"+g)) totalPoints += 1;
        if(isChecked("my_jp"+g)) totalPoints += 1;
        if(g>=4){
            if(isChecked("my_sci"+g)) totalPoints += 1;
            if(isChecked("my_soc"+g)) totalPoints += 1;
        }
    }

    // 中学生パワーアップゼミ（ライト版） (中学生パワーアップゼミの各半分のポイント)
    for(var g=1; g<=3; g++){
        if(isChecked("light_eng"+g)) totalPoints += 0.5; 
        if(isChecked("light_math"+g)) totalPoints += 0.5;
        if(isChecked("light_jp"+g)) totalPoints += 0.5;
        if(isChecked("light_sci"+g)) totalPoints += 0.25; 
        if(isChecked("light_soc"+g)) totalPoints += 0.25;
    }
    
    // 高校SPIRAL・現役合格システム (各科目: 1.25P)
    var highIds = [
        "high_eng1","high_eng2","high_math1","high_mathA","high_math2","high_mathB","high_math3","high_mathC",
        "high_jpMod","high_jpModEx","high_jpModExam","high_jpCla","high_jpClaEx","high_jpClaExam","high_jpChi","high_jpChiEx","high_jpChiExam",
        "high_sciPhy","high_sciBio","high_sciChem","high_socGeo","high_socHist"
    ];
    for(var i=0;i<highIds.length;i++){
        if(isChecked(highIds[i])) totalPoints += 1.25;
    }

    // サマー練成・ウィンター練成、中学生Focus (学年ごとに選択科目数でポイントが変わる)
    
    // サマー練成・ウィンター練成
    for(var g=1; g<=6; g++){
        var cnt = 0;
        if(isChecked("summer_eng"+g)) cnt++;
        if(isChecked("summer_math"+g)) cnt++;
        if(isChecked("summer_jp"+g)) cnt++;
        if(g>=4){
            if(isChecked("summer_sci"+g)) cnt++;
            if(isChecked("summer_soc"+g)) cnt++;
        }
        
        if (cnt === 2) totalPoints += 0.75; 
        else if (cnt === 3) totalPoints += 1;    
        else if (cnt === 5) totalPoints += 1.5;   
    }
    
    // 中学生Focus
    for(var g=1; g<=3; g++){
        var cnt = 0;
        if(isChecked("focus_eng"+g)) cnt++;
        if(isChecked("focus_math"+g)) cnt++;
        if(isChecked("focus_jp"+g)) cnt++;
        if(isChecked("focus_sci"+g)) cnt++;
        if(isChecked("focus_soc"+g)) cnt++;
        
        if (cnt === 2) totalPoints += 0.75; 
        else if (cnt === 3) totalPoints += 1;    
        else if (cnt === 5) totalPoints += 1.5;   
    }

    // 小数点第2位まで保持
    return Math.round(totalPoints * 100) / 100;
}


/* 主処理 */
function calculate(){
    var totalText = 0;
    // (商品価格合計 totalText の計算ロジックは省略 - 変更なし)
    // 小学生パワーアップゼミ
    for(var g=1; g<=6; g++){
        if(isChecked("eng"+g)) totalText += PRICE.eng;
        if(isChecked("math"+g)) totalText += PRICE.math;
        if(isChecked("jp"+g)) totalText += PRICE.jp;
        if(g>=5){
            if(isChecked("sci"+g)) totalText += PRICE.sci;
            if(isChecked("soc"+g)) totalText += PRICE.soc;
        }
    }
    // マイジュック
    for(var g=1; g<=6; g++){
        if(isChecked("my_eng"+g)) totalText += PRICE.my;
        if(isChecked("my_math"+g)) totalText += PRICE.my;
        if(isChecked("my_jp"+g)) totalText += PRICE.my;
        if(g>=4){
            if(isChecked("my_sci"+g)) totalText += PRICE.my;
            if(isChecked("my_soc"+g)) totalText += PRICE.my;
        }
    }
    // 中学生パワーアップゼミ
    for(var g=1; g<=3; g++){
        if(isChecked("jun_eng"+g)) totalText += PRICE.eng;
        if(isChecked("jun_math"+g)) totalText += PRICE.math;
        if(isChecked("jun_jp"+g)) totalText += PRICE.jp;
        if(isChecked("jun_sci"+g)) totalText += PRICE.sci;
        if(isChecked("jun_soc"+g)) totalText += PRICE.soc;
    }
    // 中学生パワーアップゼミ（ライト版）
    for(var g=1; g<=3; g++){
        if(isChecked("light_eng"+g)) totalText += PRICE.light_eng;
        if(isChecked("light_math"+g)) totalText += PRICE.light_math;
        if(isChecked("light_jp"+g)) totalText += PRICE.light_jp;
        if(isChecked("light_sci"+g)) totalText += PRICE.light_sci;
        if(isChecked("light_soc"+g)) totalText += PRICE.light_soc;
    }
    
    // サマー練成・ウィンター練成 (ボーナス元本)
    var summerTotal = 0;
    for(var g=1; g<=6; g++){
        var cnt = 0;
        if(isChecked("summer_eng"+g)) cnt++;
        if(isChecked("summer_math"+g)) cnt++;
        if(isChecked("summer_jp"+g)) cnt++;
        if(g>=4){
            if(isChecked("summer_sci"+g)) cnt++;
            if(isChecked("summer_soc"+g)) cnt++;
        }
        if(cnt === 2 || cnt === 3 || cnt === 5){
            summerTotal += PRICE.summerMap[cnt];
        }
    }
    totalText += summerTotal;
    
    // 中学生Focus (ボーナス元本)
    var focusTotal = 0;
    for(var g=1; g<=3; g++){
        var cnt = 0;
        if(isChecked("focus_eng"+g)) cnt++;
        if(isChecked("focus_math"+g)) cnt++;
        if(isChecked("focus_jp"+g)) cnt++;
        if(isChecked("focus_sci"+g)) cnt++;
        if(isChecked("focus_soc"+g)) cnt++;
        if(cnt === 2 || cnt === 3 || cnt === 5){
            focusTotal += PRICE.focusMap[cnt];
        }
    }
    totalText += focusTotal;
    
    // 高校SPIRAL・現役合格システム
    var highIds = [
        "high_eng1","high_eng2","high_math1","high_mathA","high_math2","high_mathB","high_math3","high_mathC",
        "high_jpMod","high_jpModEx","high_jpModExam","high_jpCla","high_jpClaEx","high_jpClaExam","high_jpChi","high_jpChiEx","high_jpChiExam",
        "high_sciPhy","high_sciBio","high_sciChem","high_socGeo","high_socHist"
    ];
    for(var i=0;i<highIds.length;i++){
        if(isChecked(highIds[i])) totalText += PRICE.high;
    }

    // ポイント計算
    var totalPoints = calculatePoints();

    // 分割計算に必要な値を取得
    var installInput = document.getElementById("install");
    var install = parseInt(installInput.value, 10) || 0;
    if(install <= 0) { 
        document.getElementById("result").innerHTML = "<p style='color:red; text-align:center; padding:10px;'>⚠ 分割回数を入力してください ⚠</p>";
        return;
    }

    var discount = getDiscount(totalText, install);
    var cashPrice = Math.floor(totalText - discount);
    var deposit = 0;
    var balance = cashPrice - deposit;
    var addon = parseFloat(document.getElementById("credit").value) || 0;
    var fee = Math.floor(balance * addon * install);
    var installmentTotal = balance + fee;
    var totalPayment = installmentTotal;
    
    
    // ----------------------------------------------------------------------
    // ボーナス・分割金額の計算ロジック (イレギュラー対応済み)
    
    // 1. ボーナス回数を決定（分割回数で自動決定）
    var bonusTimes = 0;
    if(install === 1){ bonusTimes = 0; }
    else if(install >= 12 && install < 24){ bonusTimes = 2; }
    else if(install >= 24 && install < 36){ bonusTimes = 4; }
    else if(install === 36){ bonusTimes = 6; }
    else { bonusTimes = 0; }
    
    // 2. ユーザー入力値（イレギュラー金額）を取得
    var isIrregular = document.getElementById('irregularCheck').checked;
    var inputBonusPer = parseInt(document.getElementById("bonusPerInput").value, 10) || 0;
    
    var bonusPer = 0;
    var bonusSum = 0;

    if (bonusTimes > 0 && ((summerTotal + focusTotal) > 0 || isIrregular)) {
        if (isIrregular && inputBonusPer > 0) {
            // イレギュラー計算にチェックがあり、金額が入力されている場合はそれを優先
            bonusPer = inputBonusPer;
        } else if ((summerTotal + focusTotal) > 0) {
            // 通常のボーナス元本（サマー/フォーカス）がある場合、自動計算
            var bonusBase = summerTotal + focusTotal;
            bonusPer = Math.floor(bonusBase / bonusTimes);
        }
        
        bonusSum = bonusPer * bonusTimes;
        
        // 念のため、ボーナス合計が総支払額を超えないように調整
        if (bonusSum > totalPayment) {
            bonusSum = totalPayment;
            bonusPer = Math.floor(bonusSum / bonusTimes);
        }
    }
    
    // 3. 分割回数払いの基となる金額を計算
    var baseForInstall = totalPayment - bonusSum;
    if(baseForInstall < 0) baseForInstall = 0;
    
    // 4. 2回目以降の月々の金額を計算 (100円未満切り捨てを適用)
    var afterSecond = 0;
    if(install > 0){
        var rawPerInstall = Math.floor( (baseForInstall / install) / 100 ) * 100;
        afterSecond = isNaN(rawPerInstall) ? 0 : rawPerInstall;
    }
    
    // 5. 第1回目支払金額を計算 (残額すべてを第1回目に加算)
    var firstPayment = totalPayment - bonusSum - (afterSecond * Math.max(0, install - 1));
    if(firstPayment < 0) firstPayment = 0;

    // ----------------------------------------------------------------------
    
    // 計算結果の表示
    var html = "<table>";
    // ポイントを割引額の上に表示
    html += "<tr><td class='label'>合計ポイント</td><td class='value'>" + totalPoints.toFixed(2) + "P</td></tr>";
    html += "<tr><td class='label'>値引額</td><td class='value discount-value'>- " + formatInt(discount) + "円</td></tr>";
    html += "<tr><td class='label'>①現金価格合計（税込）</td><td class='value'>" + formatInt(cashPrice) + "円</td></tr>";
    if(install !== 1){
        html += "<tr><td class='label'>②申込金（頭金）</td><td class='value'>" + formatInt(deposit) + "円</td></tr>";
        html += "<tr><td class='label'>③残金（①-②）</td><td class='value'>" + formatInt(balance) + "円</td></tr>";
        html += "<tr><td class='label'>④分割払手数料</td><td class='value'>" + formatInt(fee) + "円</td></tr>";
        html += "<tr><td class='label'>⑤分割支払金合計（③+④）</td><td class='value'>" + formatInt(installmentTotal) + "円</td></tr>";
        html += "<tr><td class='label'>⑥お支払い総額（②+⑤）</td><td class='value'>" + formatInt(totalPayment) + "円</td></tr>";
        html += "<tr><td colspan='2' style='text-align:center;'>--- 分割内訳 (" + install + "回払い) ---</td></tr>";
        html += "<tr><td class='label'>第1回目分割支払金</td><td class='value'>" + formatInt(firstPayment) + "円</td></tr>";
        html += "<tr><td class='label'>2回目以降分割支払金×" + Math.max(0, install - 1) + "回</td><td class='value'>" + formatInt(afterSecond) + "円</td></tr>";
        
        // ボーナス支払いがある場合のみ表示
        if (bonusSum > 0) {
            html += "<tr><td class='label'>ボーナス月加算分割支払金×" + bonusTimes + "回</td><td class='value'>" + formatInt(bonusPer) + "円</td></tr>";
        }
    }
    html += "</table>";
    document.getElementById("result").innerHTML = html;
}

/* 折りたたみ機能 */
function toggleTable(id) {
    var tableDiv = document.getElementById(id);
    var iconSpan = document.getElementById('toggle_icon_' + id);
    if (tableDiv.classList.contains('collapsed')) {
        tableDiv.classList.remove('collapsed');
        iconSpan.textContent = "[-]";
    } else {
        tableDiv.classList.add('collapsed');
        iconSpan.textContent = "[+]";
    }
}

/* リセット */
function resetChecks(){
    // チェックボックスのリセット
    var inputs = document.getElementsByTagName("input");
    for(var i=0;i<inputs.length;i++){
        if(inputs[i].type && inputs[i].type.toLowerCase() === "checkbox"){
            inputs[i].checked = false;
        }
    }
    // 分割回数のリセット
    document.getElementById("install").value = "";
    
    // イレギュラー入力もリセット
    document.getElementById('irregularCheck').checked = false;
    document.getElementById('irregularBonusContainer').classList.add('hidden');
    document.getElementById('bonusPerInput').value = "";
    
    // 結果エリアのリセット
    document.getElementById("result").innerHTML = "";

    // テーブルの折りたたみ状態もリセット（全て折りたたむ）
    var tableDivs = document.querySelectorAll('.responsive-table');
    var iconSpans = document.querySelectorAll('[id^="toggle_icon_"]');

    tableDivs.forEach(function(div) {
        div.classList.add('collapsed');
    });

    iconSpans.forEach(function(span) {
        span.textContent = "[+]";
    });
}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    var installInput = document.getElementById('install');

    // キー入力時の処理
    installInput.addEventListener('keypress', function(e) {
        if (e.key.match(/[^0-9]/)) {
            e.preventDefault();
        }
    });

    // 貼り付け時の処理
    installInput.addEventListener('paste', function(e) {
        var paste = (e.clipboardData || window.clipboardData).getData('text');
        var cleanPaste = paste.replace(/[^0-9]/g, '');
        if (cleanPaste !== paste) {
            e.preventDefault();
            document.execCommand('insertText', false, cleanPaste);
        }
    });
    
    // 初期状態でイレギュラー入力を隠す
    document.getElementById('irregularBonusContainer').classList.add('hidden');
});
</script>
</body>
</html>






